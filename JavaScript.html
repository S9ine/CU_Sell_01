<script>

// ===================================================
// === 1. GLOBAL STATE MANAGEMENT & CONSTANTS ===
// ===================================================
const AppState = {
    allSalesData: [], allCustomerData: [], masterCustomerList: [],
    masterProductList: [], allStockData: { headers: [], data: [] },
    salesCurrentPage: 1, customersCurrentPage: 1, isSalesFormDirty: false,
};
const ROWS_PER_PAGE = 10;
let salesModalInstance, settingsModalInstance, customerModalInstance;
let customerForm, customerSubmitBtn, salesForm, salesSubmitBtn, salesFormDocId;

// ===================================================
// === 2. INITIAL PAGE LOAD & EVENT LISTENERS SETUP ===
// ===================================================

document.addEventListener('DOMContentLoaded', () => {
    const salesModalElement = document.getElementById('sales-form-modal');
    salesModalInstance = new bootstrap.Modal(salesModalElement);
    settingsModalInstance = new bootstrap.Modal(document.getElementById('settings-modal'));
    customerModalInstance = new bootstrap.Modal(document.getElementById('customer-form-modal'));

    customerForm = document.getElementById('customerForm');
    customerSubmitBtn = document.getElementById('customer-submit-btn');
    salesForm = document.getElementById('salesForm');
    salesSubmitBtn = document.getElementById('sales-submit-btn');
    salesFormDocId = document.getElementById('salesFormDocId');

    // [UPGRADED] ใช้ Swal.fire แทน confirm() เมื่อพยายามปิดฟอร์ม
    salesModalElement.addEventListener('hide.bs.modal', function (event) {
        if (AppState.isSalesFormDirty) {
            event.preventDefault(); // หยุดการปิดไว้ก่อนเสมอ
            Swal.fire({
                title: 'ยังไม่ได้บันทึกข้อมูล',
                text: "คุณมีการเปลี่ยนแปลงที่ยังไม่ได้บันทึก, ต้องการปิดใช่หรือไม่?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ใช่, ปิดเลย',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    AppState.isSalesFormDirty = false; // รีเซ็ตสถานะ
                    salesModalInstance.hide(); // สั่งปิด Modal จริงๆ
                }
            });
        }
    });

    salesForm.addEventListener('input', () => { AppState.isSalesFormDirty = true; });

    document.getElementById("settings-form").addEventListener("submit", handleSettingsSubmit);
    salesForm.addEventListener('submit', handleSalesSubmit);
    customerForm.addEventListener('submit', handleCustomerSubmit);

    renderModuleHeader();
    loadInitialData();
});


// ===================================================
// === [NEW] DYNAMIC UI RENDERING ===
// ===================================================
function renderModuleHeader() {
    const mainContainer = document.querySelector('.main-container');
    if (!mainContainer) return;

    const moduleThemes = {
        'stock':     { color: '#3b82f6', icon: 'bi-bar-chart-line-fill', title: 'ภาพรวมคลังสินค้า' },
        'sales':     { color: '#22c55e', icon: 'bi-receipt-cutoff', title: 'ประวัติการขาย' },
        'customers': { color: '#8b5cf6', icon: 'bi-people-fill', title: 'จัดการลูกค้า' }
    };
    const currentTheme = moduleThemes[initialPage] || moduleThemes['stock'];

    const actionButtons = {
        'stock': `<input type="text" id="stock-search" class="form-control form-control-sm" placeholder="ค้นหาสินค้า...">`,
        'sales': `
            <input type="text" id="sales-search" class="form-control form-control-sm" placeholder="ค้นหา...">
            <button type="button" class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#sales-form-modal" onclick="resetSalesForm()">
               <i class="bi bi-plus-circle-fill"></i> สร้างเอกสารขาย
            </button>`,
        'customers': `
            <input type="text" id="customer-search" class="form-control form-control-sm" placeholder="ค้นหาชื่อลูกค้า...">
            <button type="button" class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#customer-form-modal" onclick="resetCustomerForm()">
                <i class="bi bi-person-plus-fill"></i> เพิ่มลูกค้าใหม่
            </button>`
    };

    const moduleHeaderHtml = `
        <div class="module-header-sticky d-flex justify-content-between align-items-center mb-4 px-4 py-3" 
             style="background-color: ${currentTheme.color}; color: white; border-radius: 0.75rem;">
            <div class="d-flex align-items-center">
                <a href="${dashboardUrl}" class="btn btn-sm btn-outline-light me-3" onclick="showLoader()">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <h4 class="mb-0 d-flex align-items-center">
                    <i class="bi ${currentTheme.icon} me-2"></i>
                    ${currentTheme.title}
                </h4>
            </div>
            <div class="card-header-actions d-flex align-items-center gap-2">
                ${actionButtons[initialPage] || ''}
                 <button class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#settings-modal" onclick="openSettings()"><i class="bi bi-gear-fill"></i></button>
            </div>
        </div>
    `;
    mainContainer.insertAdjacentHTML('afterbegin', moduleHeaderHtml);

    // Now that the header is rendered, attach listeners to the search inputs
    const stockSearch = document.getElementById('stock-search');
    if (stockSearch) stockSearch.addEventListener('input', displayStockData);

    const salesSearch = document.getElementById('sales-search');
    if (salesSearch) salesSearch.addEventListener('input', () => { AppState.salesCurrentPage = 1; displaySalesHistory(); });
    
    const customerSearch = document.getElementById('customer-search');
    if (customerSearch) customerSearch.addEventListener('input', () => { AppState.customersCurrentPage = 1; displayCustomerList(); });
}

// ===================================================
// === 3. DATA LOADING AND DISPLAY FUNCTIONS ===
// ===================================================

function loadInitialData() {
    showLoader();
    google.script.run.withSuccessHandler(response => {
        hideLoader();
        if (response.error) {
            onFailure({ message: response.error });
            return;
        }

        // 1. Assign all data from the server response to AppState
        AppState.allSalesData = response.salesData || [];
        AppState.allCustomerData = response.customerData || [];
        AppState.masterCustomerList = response.customerData || [];
        AppState.allStockData = response.stockData || { headers: [], data: [] };
        AppState.masterProductList = response.productList || [];
        
        // 2. NOW that we have data, render the correct header
        renderHeader();

        // 3. Populate dropdowns and other elements
        populateDatalist('customer-options', AppState.masterCustomerList.map(c => c.name));
        populateDatalist('product-options', AppState.masterProductList.map(p => p.displayValue));
        populateSelect('salesperson', response.employeeList || []);
        
        // [CORRECT PLACEMENT] เพิ่มแถวเริ่มต้น 1 แถว หลังจากทุกอย่างพร้อมแล้ว
        addSalesItemRow();

        // 4. Finally, display the content for the correct page
        const section = document.getElementById(`${initialPage}-section`);
        if (section) {
            document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
            section.classList.add("active");
        }
        
        if (initialPage === 'sales') displaySalesHistory();
        if (initialPage === 'customers') displayCustomerList();
        if (initialPage === 'stock') displayStockData();
        
    }).withFailureHandler(onFailure).getInitialData();
}


function loadSalesHistory() {
    showLoader();
    google.script.run.withSuccessHandler(data => {
        hideLoader();
        AppState.allSalesData = data || [];
        AppState.salesCurrentPage = 1;
        displaySalesHistory();
    }).withFailureHandler(onFailure).getSalesHistory();
}

function loadCustomerList() {
    showLoader();
    google.script.run.withSuccessHandler(data => {
        hideLoader();
        AppState.allCustomerData = data || [];
        AppState.masterCustomerList = data || [];
        populateDatalist('customer-options', AppState.masterCustomerList.map(c => c.name));
        AppState.customersCurrentPage = 1;
        displayCustomerList();
    }).withFailureHandler(onFailure).getCustomers();
}

function displaySalesHistory() {
    const searchTerm = document.getElementById('sales-search').value.toLowerCase();
    const filteredData = searchTerm ? AppState.allSalesData.filter(rec => rec.docId.toLowerCase().includes(searchTerm) || rec.customerName.toLowerCase().includes(searchTerm) || rec.salesperson.toLowerCase().includes(searchTerm)) : AppState.allSalesData;
    
    const tbody = document.getElementById('salesHistoryTableBody');
    tbody.innerHTML = '';
    
    if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">ไม่พบข้อมูล</td></tr>';
    } else {
        const paginatedData = filteredData.slice((AppState.salesCurrentPage - 1) * ROWS_PER_PAGE, AppState.salesCurrentPage * ROWS_PER_PAGE);
        paginatedData.forEach(rec => {
            const itemsHtml = rec.items.map(i => `<li>${i.name} (${i.quantity} ${i.unitName})</li>`).join('');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${rec.docId}</td>
                <td>${rec.date}</td>
                <td><div>${rec.customerName}</div>
                <small class="text-muted">${rec.customerTel || ''}</small></td>
                <td>${rec.salesperson}</td><td><ul class="list-unstyled mb-0 small">${itemsHtml}</ul></td>
                <td class="text-end"><b>฿ ${rec.grandTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</b></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-warning" onclick='editSale(${JSON.stringify(rec)})'><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-info" onclick='printSaleRecord(${JSON.stringify(rec)})'><i class="bi bi-printer-fill"></i></button>
                        <button class="btn btn-danger" onclick="deleteSale('${rec.docId}')"><i class="bi bi-trash-fill"></i></button>
                    </div>
                </td>`;
        });
    }
    setupPagination('sales-pagination', AppState.salesCurrentPage, filteredData.length, (page) => {
        AppState.salesCurrentPage = page;
        displaySalesHistory();
    });
}

function displayCustomerList() {
    const searchInput = document.getElementById('customer-search');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";
    const filteredData = searchTerm ? AppState.allCustomerData.filter(c => c.name.toLowerCase().includes(searchTerm)) : AppState.allCustomerData;
    
    const tbody = document.getElementById('customerTableBody');
    tbody.innerHTML = '';

    if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">ไม่พบข้อมูลลูกค้า</td></tr>';
    } else {
        const paginatedData = filteredData.slice((AppState.customersCurrentPage - 1) * ROWS_PER_PAGE, AppState.customersCurrentPage * ROWS_PER_PAGE);
        paginatedData.forEach(customer => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${customer.id}</td>
                <td>${customer.name}</td>
                <td>${customer.tel}</td>
                <td class="text-end">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-warning" onclick='editCustomer(${JSON.stringify(customer)})'><i class="bi bi-pencil"></i></button> 
                        <button class="btn btn-danger" onclick="deleteCustomer('${customer.id}')"><i class="bi bi-trash"></i></button>
                    </div>
                </td>`;
        });
    }
    setupPagination('customer-pagination', AppState.customersCurrentPage, filteredData.length, (page) => {
        AppState.customersCurrentPage = page;
        displayCustomerList();
    });
}

function displayStockData() {
    const head = document.getElementById("stockTableHead");
    const body = document.getElementById("stockTableBody");
    head.innerHTML = ""; 
    body.innerHTML = "";

    if (AppState.allStockData.error) { 
        body.innerHTML = `<tr><td colspan="10" class="text-center text-danger">เกิดข้อผิดพลาด: ${AppState.allStockData.error}</td></tr>`; 
        return; 
    }

    const searchTerm = document.getElementById('stock-search').value.toLowerCase();
    const filteredData = searchTerm 
        ? AppState.allStockData.data.filter(row => row.some(cell => String(cell).toLowerCase().includes(searchTerm))) 
        : AppState.allStockData.data;

    if (AppState.allStockData.headers && AppState.allStockData.headers.length > 0) {
        head.innerHTML = `<tr><th>${AppState.allStockData.headers.join('</th><th>')}</th></tr>`;
    }

    if (filteredData.length > 0) {
        let tableHtml = '';
        filteredData.forEach(rowData => {
            tableHtml += '<tr>';
            rowData.forEach((cellData, index) => {
                if (index === 2) { 
                    const number = parseFloat(String(cellData).replace(/,/g, ''));
                    const formattedNumber = !isNaN(number) ? number.toLocaleString('en-US') : cellData;
                    tableHtml += `<td style="text-align: center;">${formattedNumber}</td>`;
                } else {
                    tableHtml += `<td>${cellData}</td>`;
                }
            });
            tableHtml += '</tr>';
        });
        body.innerHTML = tableHtml;
    } else {
        const colCount = AppState.allStockData.headers ? AppState.allStockData.headers.length : 4;
        body.innerHTML = `<tr><td colspan="${colCount}" class="text-center">ไม่พบข้อมูล</td></tr>`;
    }
}

// ===================================================
// === 4. FORM HANDLING & SUBMISSIONS ===
// ===================================================

function handleSettingsSubmit(e) {
    e.preventDefault();
    const settingsData = { 
        companyName: document.getElementById("setting-companyName").value, 
        address1: document.getElementById("setting-address1").value, 
        address2: document.getElementById("setting-address2").value, 
        contactInfo: document.getElementById("setting-contactInfo").value 
    };
    showLoader();
    google.script.run.withSuccessHandler(response => {
        hideLoader();
        showToast(response.message, response.success ? 'success' : 'danger');
        if (response.success) { 
            settingsModalInstance.hide();
        }
    }).withFailureHandler(onFailure).saveDocumentInfo(settingsData);
}

function handleSalesSubmit(e) {
    e.preventDefault();
    salesSubmitBtn.disabled = true;

    const subtotal = parseFloat(document.getElementById('subtotal').innerText.replace(/[฿,]/g, ''));
    const discount = parseFloat(document.getElementById('discount').value.replace(/,/g, '')) || 0;
    const grandTotal = parseFloat(document.getElementById('grandTotal').innerText.replace(/[฿,]/g, ''));

    const items = Array.from(document.getElementById('salesItemTableBody').rows).map(row => {
        const quantity = parseFloat(row.querySelector('[name="quantity"]').value);
        const price = parseFloat(row.querySelector('[name="price"]').value.replace(/,/g, '')) || 0;
        const unitSelect = row.querySelector('[name="unit"]');
        const selectedValue = row.querySelector('[name="itemName"]').value;
        const product = AppState.masterProductList.find(p => p.displayValue === selectedValue);

        const unitFactor = parseFloat(unitSelect.value) || 1;
        const lineTotal = parseFloat((quantity * price * unitFactor).toFixed(2));

        return {
            name: product ? product.productName : selectedValue,
            quantity: quantity,
            price: parseFloat(price.toFixed(2)),
            unitName: unitSelect.options[unitSelect.selectedIndex].text,
            total: lineTotal,
            baseQuantity: quantity * unitFactor
        };
    }).filter(item => item.name && item.quantity > 0 && item.price >= 0);

    if (items.length === 0) {
        showToast('กรุณาเพิ่มรายการสินค้า', 'danger');
        salesSubmitBtn.disabled = false;
        return;
    }

    const formData = {
        docId: salesFormDocId.value,
        customerId: document.getElementById('salesCustomerId').value,
        customerName: document.getElementById('salesCustomerName').value,
        customerTel: document.getElementById('salesCustomerTel').value,
        salesperson: document.getElementById('salesperson').value,
        traysSent: parseInt(document.getElementById('salesTraysSent').value) || 0,
        traysReceived: parseInt(document.getElementById('salesTraysReceived').value) || 0,
        subtotal: parseFloat(subtotal.toFixed(2)),
        discount: parseFloat(discount.toFixed(2)),
        grandTotal: parseFloat(grandTotal.toFixed(2)),
        items: items
    };
    const isUpdate = !!formData.docId;
    const serverFunction = isUpdate ? 'updateSale' : 'saveSalesData';
    showLoader();
    google.script.run
        .withSuccessHandler(response => {
            hideLoader();
            salesSubmitBtn.disabled = false;
            if (response.success) {
                showToast(response.message, 'success');
                salesModalInstance.hide();
                resetSalesForm();
                loadInitialData(); 
            } else {
                showToast(response.message, 'danger');
            }
        })
        .withFailureHandler(onFailure)
        [serverFunction](formData);
}

function handleCustomerSubmit(e) {
    e.preventDefault();
    customerSubmitBtn.disabled = true;

    const customerData = {
        id: document.getElementById('customerId').value,
        name: document.getElementById('customerName').value,
        tel: document.getElementById('customerTel').value,
    };

    const serverFunction = customerData.id ? 'updateCustomer' : 'addCustomer';
    
    showLoader();
    google.script.run.withSuccessHandler(response => {
        hideLoader();
        customerSubmitBtn.disabled = false;
        if (response.success) {
            showToast(response.message, 'success');
            customerModalInstance.hide();
            loadCustomerList(); 

            if (serverFunction === 'addCustomer' && response.newCustomer) {
                document.getElementById('salesCustomerName').value = response.newCustomer.name;
                document.getElementById('salesCustomerTel').value = response.newCustomer.tel;
                document.getElementById('salesCustomerId').value = response.newCustomer.id;
            }
        } else { 
            showToast(response.message, 'danger'); 
        }
    }).withFailureHandler(onFailure)[serverFunction](customerData);
}

function deleteSale(docId) {
    // [UPGRADED] ใช้ Swal.fire แทน confirm()
    Swal.fire({
        title: 'ยืนยันการลบ',
        html: `คุณต้องการลบเอกสาร <b>${docId}</b> ใช่หรือไม่?<br/><small class="text-danger">การกระทำนี้จะคืนสินค้าเข้าสต็อกและไม่สามารถย้อนกลับได้</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'ลบข้อมูล',
        cancelButtonText: 'ยกเลิก'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoader();
            google.script.run.withSuccessHandler(response => {
                hideLoader();
                if (response.success) {
                    Swal.fire('ลบสำเร็จ!', response.message, 'success');
                    loadInitialData();
                } else {
                    Swal.fire('เกิดข้อผิดพลาด!', response.message, 'error');
                }
            }).withFailureHandler(onFailure).deleteSaleById(docId);
        }
    });
}

function deleteCustomer(customerId) {
    // [UPGRADED] ใช้ Swal.fire แทน confirm()
    Swal.fire({
        title: 'ยืนยันการลบ',
        text: `คุณต้องการลบข้อมูลลูกค้ารหัส ${customerId} ใช่หรือไม่?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'ลบข้อมูล',
        cancelButtonText: 'ยกเลิก'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoader();
            google.script.run.withSuccessHandler(response => {
                hideLoader();
                 if (response.success) {
                    Swal.fire('ลบสำเร็จ!', response.message, 'success');
                    loadCustomerList();
                } else {
                    Swal.fire('เกิดข้อผิดพลาด!', response.message, 'error');
                }
            }).withFailureHandler(onFailure).deleteCustomer(customerId);
        }
    });
}

// ===================================================
// === 5. SALES FORM DYNAMIC BEHAVIOR ===
// ===================================================

function addSalesItemRow() {
    const tbody = document.getElementById('salesItemTableBody');
    const newRow = tbody.insertRow();
    newRow.innerHTML = `
        <td class="align-top">
            <input class="form-control form-control-sm" list="product-options" name="itemName" required oninput="checkStock(this)" placeholder="ค้นหาสินค้า...">
            <small class="text-muted stock-display"></small> 
        </td>
        <td class="align-top" style="max-width: 120px;">
            <input type="number" class="form-control form-control-sm" name="quantity" value="1" min="1" max="999999" oninput="calculateTotals(); checkAllRowsStockValidity();" required>
        </td>
        <td class="align-top" style="max-width: 110px;">
            <select class="form-select form-select-sm unit-select" name="unit" onchange="calculateTotals(); checkAllRowsStockValidity();">
                <option value="1" selected>ฟอง</option>
                <option value="30">แผง</option>
            </select>
        </td>
        <td class="align-top" style="max-width: 120px;">
            <input type="number" class="form-control form-control-sm text-end" name="price" value="0.00" min="0" max="9999999.99" step="0.01" oninput="calculateTotals()" required>
        </td>
        <td class="align-top text-end">
            <span class="fs-6 fw-bold">฿ 0.00</span>
        </td>
        <td class="align-top">
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteSalesItemRow(this)"><i class="bi bi-x-lg"></i></button>
        </td>
    `;
}

function deleteSalesItemRow(btn) {
    if (document.getElementById('salesItemTableBody').rows.length > 1) {
        btn.closest('tr').remove();
        calculateTotals();
        checkAllRowsStockValidity();
    } else { 
        showToast('ต้องมีอย่างน้อย 1 รายการ', 'warning'); 
    }
}

function calculateTotals() {
    let subtotal = 0;
    document.getElementById('salesItemTableBody').querySelectorAll('tr').forEach(row => {
        const quantity = parseFloat(row.querySelector('[name="quantity"]').value) || 0;
        const price = parseFloat(row.querySelector('[name="price"]').value.replace(/,/g, '')) || 0;
        const unitFactor = parseFloat(row.querySelector('[name="unit"]').value) || 1;
        
        const lineTotal = parseFloat((quantity * price * unitFactor).toFixed(2));
        
        subtotal += lineTotal;
        
        row.cells[4].innerHTML = `<span class="fs-6 fw-bold">฿ ${lineTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>`;
    });

    let discount = parseFloat(document.getElementById('discount').value.replace(/,/g, '')) || 0;
    
    if (discount > subtotal) {
        discount = subtotal;
        document.getElementById('discount').value = discount.toLocaleString('en-US'); 
    }

    const grandTotal = parseFloat((subtotal - discount).toFixed(2));
    
    document.getElementById('subtotal').innerText = `฿ ${subtotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    document.getElementById('grandTotal').innerText = `฿ ${grandTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

function checkStock(inputElement) {
    const selectedValue = inputElement.value;
    const row = inputElement.closest('tr');
    const displayElement = row.querySelector('.stock-display');
    const product = AppState.masterProductList.find(p => p.displayValue === selectedValue);

    if (product) {
        displayElement.innerHTML = `คงเหลือ: ${product.stockCentral.toLocaleString('en-US')}`;
        displayElement.style.color = product.stockCentral > 0 ? '#6c757d' : '#dc3545';
    } else {
        displayElement.innerHTML = 'ไม่พบสินค้า';
        displayElement.style.color = '#dc3545';
    }
    checkAllRowsStockValidity();
}

function checkAllRowsStockValidity() {
    let isAnyRowInvalid = false;
    const isUpdate = !!salesFormDocId.value;

    document.getElementById('salesItemTableBody').querySelectorAll('tr').forEach(row => {
        const productNameInput = row.querySelector('[name="itemName"]');
        const quantityInput = row.querySelector('[name="quantity"]');
        const unitSelect = row.querySelector('[name="unit"]');
        const stockDisplay = row.querySelector('.stock-display');
        
        const product = AppState.masterProductList.find(p => p.displayValue === productNameInput.value);

        if (!product) {
            quantityInput.classList.remove('is-invalid');
            stockDisplay.innerHTML = 'ไม่พบสินค้า';
            stockDisplay.style.color = '#dc3545';
            isAnyRowInvalid = true;
            return;
        }

        const quantitySold = (parseFloat(quantityInput.value) || 0) * (parseFloat(unitSelect.value) || 1);
        let stockAvailable = product.stockCentral;

        if (isUpdate) {
            const originalBaseQuantity = parseFloat(row.dataset.originalBaseQuantity) || 0;
            stockAvailable += originalBaseQuantity;
        }

        if (quantitySold > stockAvailable) {
            quantityInput.classList.add('is-invalid');
            quantityInput.title = `สต็อกไม่เพียงพอ (มี: ${stockAvailable})`; 
            isAnyRowInvalid = true;
        } else {
            quantityInput.classList.remove('is-invalid');
            quantityInput.title = '';
        }
    });
    salesSubmitBtn.disabled = isAnyRowInvalid;
}

function editSale(record) {
    resetSalesForm(); 
    document.getElementById('salesFormModalLabel').innerText = `แก้ไขเอกสาร: ${record.docId}`;
    salesFormDocId.value = record.docId;
    
    document.getElementById('salesCustomerId').value = record.customerId || '';
    salesSubmitBtn.innerText = 'อัปเดตข้อมูล';
    salesSubmitBtn.classList.replace('btn-primary', 'btn-warning');

    document.getElementById('salesCustomerName').value = record.customerName;
    document.getElementById('salesCustomerTel').value = record.customerTel;
    document.getElementById('salesperson').value = record.salesperson;
    document.getElementById('salesperson').disabled = true;
    document.getElementById('discount').value = record.discount;
    document.getElementById('salesTraysSent').value = record.traysSent || 0;
    document.getElementById('salesTraysReceived').value = record.traysReceived || 0;

    const tbody = document.getElementById('salesItemTableBody');
    tbody.innerHTML = ''; 

    if (record.items) {
        record.items.forEach(item => {
            addSalesItemRow();
            const newRow = tbody.rows[tbody.rows.length - 1];
            
            newRow.dataset.originalBaseQuantity = item.baseQuantity || 0;

            const product = AppState.masterProductList.find(p => p.productName === item.name);
            if (product) {
                newRow.querySelector('[name="itemName"]').value = product.displayValue;
            }
            newRow.querySelector('[name="quantity"]').value = item.quantity;
            newRow.querySelector('[name="price"]').value = item.price;
            
            const unitSelect = newRow.querySelector('[name="unit"]');
            for (let option of unitSelect.options) {
                if (option.text === item.unitName) {
                    option.selected = true;
                    break;
                }
            }
        });
    }

    calculateTotals();
    checkAllRowsStockValidity();
    salesModalInstance.show();
}

function resetSalesForm() {
    // [IMPROVEMENT] ตั้งค่าสถานะ Dirty เป็น false ชั่วคราวก่อน Reset เพื่อไม่ให้ Trigger confirm()
    AppState.isSalesFormDirty = false;
    salesForm.reset();
    salesFormDocId.value = '';
    document.getElementById('salesCustomerId').value = '';
    document.getElementById('salesCustomerTel').value = '';
    document.getElementById('discount').value = '0';
    document.getElementById('salesItemTableBody').innerHTML = '';
    addSalesItemRow();
    calculateTotals();
    checkAllRowsStockValidity();

    document.getElementById('salesFormModalLabel').innerText = 'สร้างเอกสารขาย';
    salesSubmitBtn.innerText = 'บันทึกการขาย';
    salesSubmitBtn.classList.replace('btn-warning', 'btn-primary');
    document.getElementById('salesperson').disabled = false;
}

function resetCustomerForm() {
    customerForm.reset(); 
    document.getElementById('customerId').value = '';
    document.getElementById('customer-modal-title').innerText = 'เพิ่มข้อมูลลูกค้าใหม่';
    customerSubmitBtn.innerHTML = '<i class="bi bi-save"></i> บันทึกข้อมูล';
}

function editCustomer(customer) {
    resetCustomerForm();
    document.getElementById('customerId').value = customer.id;
    document.getElementById('customerName').value = customer.name;
    document.getElementById('customerTel').value = customer.tel;
    document.getElementById('customer-modal-title').innerText = `แก้ไขข้อมูล: ${customer.name}`;
    customerSubmitBtn.innerHTML = '<i class="bi bi-pencil-square"></i> อัปเดตข้อมูล';
    customerModalInstance.show();
}

// ===================================================
// === 6. UTILITY & HELPER FUNCTIONS ===
// ===================================================

function setupPagination(containerId, currentPage, totalRows, pageChangeCallback) {
    const paginationContainer = document.getElementById(containerId);
    paginationContainer.innerHTML = '';
    if (totalRows <= ROWS_PER_PAGE) return;

    const totalPages = Math.ceil(totalRows / ROWS_PER_PAGE);

    const createPageItem = (page, content, isDisabled = false, isActive = false) => {
        const li = document.createElement('li');
        li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.innerHTML = content;
        if (!isDisabled) {
            a.onclick = (e) => { 
                e.preventDefault(); 
                pageChangeCallback(page); 
            };
        }
        li.appendChild(a);
        return li;
    };

    paginationContainer.appendChild(createPageItem(currentPage - 1, '&laquo;', currentPage === 1));
    for (let i = 1; i <= totalPages; i++) {
        paginationContainer.appendChild(createPageItem(i, i, false, i === currentPage));
    }
    paginationContainer.appendChild(createPageItem(currentPage + 1, '&raquo;', currentPage === totalPages));
}

function populateDatalist(id, items) {
    const list = document.getElementById(id);
    if(list) {
        list.innerHTML = items.map(item => `<option value="${item}"></option>`).join('');
    }
}

function populateSelect(selectId, items) {
    const select = document.getElementById(selectId);
    if (!select) return;
    const placeholder = select.options[0];
    select.innerHTML = ''; 
    select.appendChild(placeholder);
    if (items) {
        items.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item; 
            opt.textContent = item;
            select.appendChild(opt);
        });
    }
}

function handleCustomerSelect(customerName) {
    const customer = AppState.masterCustomerList.find(c => c.name === customerName);
    const telInput = document.getElementById('salesCustomerTel');
    const idInput = document.getElementById('salesCustomerId');

    if (customer) {
        telInput.value = customer.tel || '';
        idInput.value = customer.id || '';
    } else {
        telInput.value = '';
        idInput.value = '';
    }
}

function openSettings() {
    showLoader();
    google.script.run.withSuccessHandler(docInfo => {
        hideLoader();
        document.getElementById("setting-companyName").value = docInfo.companyName || "";
        document.getElementById("setting-address1").value = docInfo.address1 || "";
        document.getElementById("setting-address2").value = docInfo.address2 || "";
        document.getElementById("setting-contactInfo").value = docInfo.contactInfo || "";
        settingsModalInstance.show();
    }).withFailureHandler(onFailure).getDocumentInfo();
}

function handleClearCache() {
    // [UPGRADED] ใช้ Swal.fire แทน confirm()
    Swal.fire({
        title: 'ล้างแคชหรือไม่?',
        text: "ต้องการล้างแคชและโหลดข้อมูลใหม่ทั้งหมดใช่หรือไม่?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'ใช่, ล้างแคช',
        cancelButtonText: 'ยกเลิก'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoader();
            google.script.run.withSuccessHandler(res => {
                hideLoader();
                if (res.success) {
                    // ใช้ Toast เดิมก็ได้ หรือจะใช้ Swal ก็สวยไปอีกแบบ
                    Swal.fire({
                        icon: 'success',
                        title: 'ล้างแคชสำเร็จ!',
                        text: 'กำลังโหลดข้อมูลใหม่...',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    loadInitialData();
                } else {
                    Swal.fire('เกิดข้อผิดพลาด!', res.message, 'error');
                }
            }).withFailureHandler(onFailure).clearServerCache();
        }
    });
}

function showLoader() { document.getElementById('loading-overlay').style.display = 'flex'; }
function hideLoader() { document.getElementById('loading-overlay').style.display = 'none'; }

function showToast(message, level = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${level}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 4000);
}

function onFailure(error) {
    hideLoader();
    showToast(`เกิดข้อผิดพลาด: ${error.message}`, 'danger');
    if(salesSubmitBtn) salesSubmitBtn.disabled = false;
    if(customerSubmitBtn) customerSubmitBtn.disabled = false;
}

// Print functions
function printSaleRecord(record) {
    showLoader();
    google.script.run.withSuccessHandler(docInfo => {
        hideLoader();
        const printContent = getSalesPrintHtml(record, docInfo);
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`<html><head><title>ใบเสร็จ - ${record.docId}</title>${getPrintStyles()}</head><body>${printContent}</body></html>`);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => { printWindow.print(); }, 500);
    }).withFailureHandler(onFailure).getDocumentInfo();
}

function getPrintStyles() {
    return `
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
            body { font-family: 'Sarabun', 'Arial', sans-serif; margin: 0; color: #333; }
            .page { width: 210mm; min-height: 297mm; padding: 20mm; margin: auto; box-sizing: border-box; background: #fff; }
            .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 10mm; border-bottom: 2px solid #eee; }
            .company-details h2 { margin: 0; font-size: 1.8em; color: #0d6efd; }
            .company-details p { margin: 2px 0; font-size: 0.9em; color: #555; }
            .doc-title { text-align: right; }
            .doc-title h1 { margin: 0; font-size: 2.5em; }
            .doc-title p { margin: 2px 0; font-size: 0.9em; }
            table { width: 100%; border-collapse: collapse; }
            .info-section { margin: 8mm 0; }
            .info-section table td { padding: 5px; font-size: 0.9em; }
            .items-table { margin-top: 8mm; }
            .items-table thead { background-color: #f8f9fa !important; -webkit-print-color-adjust: exact; }
            .items-table th, .items-table td { border: 1px solid #dee2e6; padding: 8px; font-size: 0.9em; text-align: left; }
            .items-table .text-end { text-align: right; }
            .items-table .text-center { text-align: center; }
            .items-table tfoot td { border: none; }
            .items-table tfoot .grand-total { border-top: 2px solid #333; }
            .items-table tfoot .grand-total td { font-size: 1.1em; font-weight: bold; }
            .footer { margin-top: 20mm; padding-top: 10mm; border-top: 1px solid #eee; display: flex; justify-content: space-around; text-align: center; font-size: 0.9em; }
            .signature-box { width: 40%; }
            .signature-box .line { margin-top: 20mm; border-bottom: 1px solid #555; }
            .signature-box p { margin: 5px 0 0 0; }
        </style>
    `;
}

function getSalesPrintHtml(rec, info) {
    let itemsHtml = rec.items.map((item, i) => `
        <tr>
            <td class="text-center">${i + 1}</td>
            <td>${item.name}</td>
            <td class="text-center">${(item.quantity || 0).toLocaleString('en-US')} ${item.unitName}</td>
            <td class="text-end">${(item.price || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="text-end">${(item.total || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        </tr>
    `).join('');

    return `
        <div class="page">
            <div class="header">
                <div class="company-details">
                    <h2>${info.companyName}</h2>
                    <p>${info.address1}</p>
                    <p>${info.address2}</p>
                    <p>${info.contactInfo}</p>
                </div>
                <div class="doc-title">
                    <h1>ใบเสร็จรับเงิน / ใบส่งของ</h1>
                    <p>เลขที่: ${rec.docId}</p>
                    <p>วันที่: ${rec.date}</p>
                </div>
            </div>
            <div class="info-section">
                <table>
                    <tr><td style="width:15%;"><strong>ลูกค้า:</strong></td><td>${rec.customerName}</td></tr>
                    <tr><td><strong>ติดต่อ:</strong></td><td>${rec.customerTel || '-'}</td></tr>
                    <tr><td><strong>พนักงานขาย:</strong></td><td>${rec.salesperson}</td></tr>
                </table>
            </div>
            <table class="items-table">
                <thead>
                    <tr>
                        <th class="text-center" style="width:5%">#</th>
                        <th>รายการ</th>
                        <th class="text-center" style="width:20%">จำนวน</th>
                        <th class="text-end" style="width:20%">ราคา/หน่วย</th>
                        <th class="text-end" style="width:20%">ราคารวม</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHtml}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3"></td>
                        <td>ยอดรวม</td>
                        <td class="text-end">฿ ${rec.subtotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                    <tr>
                        <td colspan="3"></td>
                        <td>ส่วนลด</td>
                        <td class="text-end">฿ ${rec.discount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                    <tr class="grand-total">
                        <td colspan="3"></td>
                        <td><strong>ยอดรวมสุทธิ</strong></td>
                        <td class="text-end"><strong>฿ ${rec.grandTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></td>
                    </tr>
                </tfoot>
            </table>
            <div class="footer">
                <div class="signature-box">
                    <div class="line"></div>
                    <p>ผู้รับสินค้า</p>
                </div>
                <div class="signature-box">
                    <div class="line"></div>
                    <p>ผู้ส่งสินค้า / พนักงานขาย</p>
                </div>
            </div>
        </div>
    `;
}

function renderHeader() {
    const placeholder = document.getElementById('dynamic-header-placeholder');
    if (!placeholder) return;

    if (initialPage === 'stock') {
        renderStockHeader(placeholder);
    } else {
        renderGenericHeader(placeholder);
    }

    const stockSearch = document.getElementById('stock-search');
    if (stockSearch) stockSearch.addEventListener('input', displayStockData);

    const salesSearch = document.getElementById('sales-search');
    if (salesSearch) salesSearch.addEventListener('input', () => { AppState.salesCurrentPage = 1; displaySalesHistory(); });
    
    const customerSearch = document.getElementById('customer-search');
    if (customerSearch) customerSearch.addEventListener('input', () => { AppState.customersCurrentPage = 1; displayCustomerList(); });
}

function renderStockHeader(placeholder) {
    const LOW_STOCK_THRESHOLD = 10;
    const stockLevelColumnIndex = 2;
    let total = 0, lowStock = 0, outOfStock = 0;

    if (AppState.allStockData && AppState.allStockData.data && AppState.allStockData.data.length > 0) {
        total = AppState.allStockData.data.length;
        AppState.allStockData.data.forEach(row => {
            const stockValue = parseFloat(String(row[stockLevelColumnIndex]).replace(/,/g, ''));
            if (!isNaN(stockValue)) {
                if (stockValue <= 0) {
                    outOfStock++;
                } else if (stockValue <= LOW_STOCK_THRESHOLD) {
                    lowStock++;
                }
            }
        });
    }

    const now = new Date();
    const year = now.getFullYear() + 543;
    const dateOptions = { weekday: 'long', month: 'long', day: 'numeric' };
    const formattedDate = now.toLocaleDateString('th-TH', dateOptions) + ` พ.ศ. ${year}`;

    const headerHtml = `
    <div class="dashboard-header-card d-flex justify-content-between align-items-center">
        <div class="header-title-section">
            <h4><i class="bi bi-box-seam me-2"></i>สต็อก&คลังสินค้า</h4>
            <p>ข้อมูล ณ ${formattedDate}</p>
        </div>
        <div class="header-metrics-section">
            <div class="metric-item">
                <div class="metric-value">${total.toLocaleString('en-US')}</div>
                <div class="metric-label">ทั้งหมด</div>
            </div>
            <div class="metric-item">
                <div class="metric-value text-warning">${lowStock.toLocaleString('en-US')}</div>
                <div class="metric-label">ใกล้หมด</div>
            </div>
            <div class="metric-item">
                <div class="metric-value text-danger">${outOfStock.toLocaleString('en-US')}</div>
                <div class="metric-label">ของหมด</div>
            </div>
            <div class="vr mx-3"></div>
            <div class="header-actions d-flex align-items-center gap-2">
                 <input type="text" id="stock-search" class="form-control form-control-sm" placeholder="ค้นหาสินค้า...">
                 <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#settings-modal" onclick="openSettings()"><i class="bi bi-gear-fill"></i></button>
            </div>
        </div>
    </div>`;
    placeholder.innerHTML = headerHtml;
}

function renderGenericHeader(placeholder) {
    const moduleThemes = {
        'sales':     { color: '#22c55e', icon: 'bi-receipt-cutoff', title: 'ประวัติการขาย' },
        'customers': { color: '#8b5cf6', icon: 'bi-people-fill', title: 'จัดการลูกค้า' }
    };
    const currentTheme = moduleThemes[initialPage] || { color: '#6c757d', icon: 'bi-question-circle', title: 'Undefined Page' };

    const actionButtons = {
        'sales': `
            <input type="text" id="sales-search" class="form-control form-control-sm" placeholder="ค้นหา...">
            <button type="button" class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#sales-form-modal" onclick="resetSalesForm()">
               <i class="bi bi-plus-circle-fill"></i> สร้างเอกสารขาย
            </button>`,
        'customers': `
            <input type="text" id="customer-search" class="form-control form-control-sm" placeholder="ค้นหาชื่อลูกค้า...">
            <button type="button" class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#customer-form-modal" onclick="resetCustomerForm()">
                <i class="bi bi-person-plus-fill"></i> เพิ่มลูกค้าใหม่
            </button>`
    };

    const headerHtml = `
    <div class="module-header-sticky d-flex justify-content-between align-items-center mb-4 px-4 py-3" 
         style="background-color: ${currentTheme.color}; color: white; border-radius: 0.75rem;">
        <div class="d-flex align-items-center">
            <a href="${dashboardUrl}" class="btn btn-sm btn-outline-light me-3" onclick="showLoader()">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h4 class="mb-0 d-flex align-items-center">
                <i class="bi ${currentTheme.icon} me-2"></i> ${currentTheme.title}
            </h4>
        </div>
        <div class="card-header-actions d-flex align-items-center gap-2">
            ${actionButtons[initialPage] || ''}
            <button class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#settings-modal" onclick="openSettings()"><i class="bi bi-gear-fill"></i></button>
        </div>
    </div>`;
    placeholder.innerHTML = headerHtml;
} 

</script>
